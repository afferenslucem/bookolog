<form class="book" (ngSubmit)="submit()" *ngIf="bookForm" [formGroup]="form" appDatesValidator appUnitsValidator>
  <mat-form-field appearance="fill">
    <mat-label>Название</mat-label>
    <input autocomplete="off" class="book__name" formControlName="name" matInput required type="text" />
    <mat-error *ngIf="form.get('name').invalid"> Это обязательное поле</mat-error>
  </mat-form-field>

  <app-book-tags-input [list]="authors" class="book__authors" formControlName="authors" header="Авторы"></app-book-tags-input>

  <mat-form-field appearance="fill">
    <mat-label>Год выпуска</mat-label>
    <input formControlName="year" class="book__year" matInput type="number" />
  </mat-form-field>

  <mat-form-field appearance="fill">
    <mat-label>Жанр</mat-label>
    <input [matAutocomplete]="genreAutocomplete" formControlName="genre" class="book__genre" matInput type="text" />

    <mat-autocomplete #genreAutocomplete="matAutocomplete">
      <mat-option *ngFor="let genre of genres | async" [value]="genre | capitalize">
        {{ genre | capitalize }}
      </mat-option>
    </mat-autocomplete>
  </mat-form-field>

  <div class="collection-input">
    <mat-form-field appearance="fill" class="name">
      <mat-label>Серия</mat-label>
      <mat-select formControlName="collectionGuid">
        <mat-option [value]="null">Отсутствует</mat-option>
        <mat-option *ngFor="let item of allSeries" [value]="item.guid">
          {{ item.name | capitalize }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="fill" class="order">
      <mat-label>Порядок</mat-label>
      <input formControlName="collectionOrder" matInput max="256" min="1" step="1" type="number" />
    </mat-form-field>
  </div>

  <app-book-tags-input [list]="tags" class="book__tags" formControlName="tags" header="Теги"></app-book-tags-input>

  <mat-form-field appearance="fill">
    <mat-label>Статус</mat-label>
    <mat-select formControlName="status">
      <mat-option [value]="BookStatus.ToRead">К прочтению</mat-option>
      <mat-option [value]="BookStatus.InProgress">Читаю</mat-option>
      <mat-option [value]="BookStatus.Done">Прочитана</mat-option>
    </mat-select>
  </mat-form-field>

  <mat-form-field appearance="fill">
    <mat-label>Тип книги</mat-label>
    <mat-select class="book__type" formControlName="type">
      <mat-option [value]="BookType.Paper">Бумажная книга</mat-option>
      <mat-option [value]="BookType.Electronic">Электронная книга</mat-option>
      <mat-option [value]="BookType.Audio">Аудиокнига</mat-option>
    </mat-select>
  </mat-form-field>

  <mat-form-field [hidden]="status !== BookStatus.InProgress" appearance="fill">
    <mat-label>Прогресс</mat-label>
    <mat-select class="book__progressType" formControlName="progressType">
      <mat-option [value]="ProgressAlgorithm.Done">{{ type == BookType.Audio ? 'Прослушано' : 'Прочитано' }}</mat-option>
      <mat-option [value]="ProgressAlgorithm.Left">Осталось</mat-option>
    </mat-select>
  </mat-form-field>

  <div [hidden]="status !== BookStatus.InProgress" [ngSwitch]="type" class="book-edit__progress">
    <div *ngSwitchCase="BookType.Audio" class="book-edit__progress_audio">
      <div>
        <mat-label>{{ progressAlgorithm == ProgressAlgorithm.Done ? 'Прослушано' : 'Осталось' }}</mat-label>
        <app-book-time-input formControlName="doneUnits" class="book__doneUnits"></app-book-time-input>
      </div>
      <div>
        <mat-label>Всего</mat-label>
        <app-book-time-input formControlName="totalUnits" class="book__totalUnits"></app-book-time-input>
      </div>
    </div>
    <div *ngSwitchDefault class="book-edit__progress_audio">
      <mat-form-field appearance="fill">
        <mat-label>Страниц</mat-label>
        <input autocomplete="off" class="book__doneUnits" formControlName="doneUnits" matInput max="6000" min="0" step="1" type="number" />
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Всего</mat-label>
        <input
          autocomplete="off"
          class="book__totalUnits"
          formControlName="totalUnits"
          matInput
          max="6000"
          min="0"
          step="1"
          type="number"
        />
      </mat-form-field>
    </div>

    <mat-error *ngIf="form?.errors?.invalidUnits"> Неверно указан прогресс</mat-error>
  </div>

  <div [hidden]="status != BookStatus.Done && status != BookStatus.InProgress">
    <mat-label>Начало чтения</mat-label>
    <app-book-date-input class="book__started" formControlName="started"></app-book-date-input>
  </div>

  <div [hidden]="status != BookStatus.Done">
    <mat-label>Окончание чтения</mat-label>
    <app-book-date-input class="book__finished" formControlName="finished"></app-book-date-input>
  </div>

  <mat-error *ngIf="form?.errors?.invalidDates"> Дата начала больше даты окончания</mat-error>

  <mat-form-field appearance="fill">
    <mat-label>Заметки</mat-label>
    <textarea class="book__notes" autocomplete="off" formControlName="note" matInput rows="4"></textarea>
  </mat-form-field>

  <button [disabled]="form.invalid" class="w-100 book__create-button" color="primary" mat-flat-button type="submit">Сохранить</button>
</form>
